<!doctype html>
<html>
    <head>
        <title>Test Viewer</title>
        <script
            src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
            defer
        ></script>
        <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.9/dist/livekit-client.umd.min.js"></script>
    </head>
    <body>
        <div style="padding: 20px">
            <h2>Test Livestream Viewer</h2>
            <input
                type="text"
                id="deviceId"
                value="1"
                placeholder="Device ID"
            />
            <button onclick="openViewer()">Open Viewer</button>
        </div>

        <script>
            async function openViewer() {
                const deviceId = document.getElementById('deviceId').value;

                try {
                    const res = await fetch('/livekit/viewer-token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device_id: deviceId }),
                    });

                    const contentType = (
                        res.headers.get('content-type') || ''
                    ).toLowerCase();
                    const isJson = contentType.includes('application/json');

                    // Safely parse JSON or fall back to text to avoid "Unexpected token '<'" errors
                    let payload = null;
                    if (isJson) {
                        payload = await res.json().catch(() => null);
                    } else {
                        payload = await res.text().catch(() => null);
                    }

                    if (!res.ok) {
                        const message =
                            isJson && payload && payload.message
                                ? payload.message
                                : typeof payload === 'string' &&
                                    payload.trim().length
                                  ? payload
                                  : res.statusText;
                        alert('Error: ' + message);
                        return;
                    }

                    if (!isJson || !payload) {
                        alert('Error: Server did not return valid JSON.');
                        return;
                    }

                    const { token, url } = payload;

                    const LiveKit =
                        window.LivekitClient || window.livekitClient;
                    const room = new LiveKit.Room();

                    await room.connect(url, token);
                    console.log('Connected to room!');

                    room.on('trackSubscribed', (track) => {
                        const videoEl = track.attach();
                        videoEl.style.width = '100%';
                        videoEl.style.maxWidth = '800px';
                        document.body.appendChild(videoEl);
                    });
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                }
            }
        </script>
    </body>
</html>
